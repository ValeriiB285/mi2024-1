<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Тема 5. Заняття 4 — Візуальні елементи</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Red+Hat+Mono:wght@500&display=swap" rel="stylesheet">
  <!-- Leaflet без SRI, щоб не блокувалося у локальному/live-сервері -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <style>
    :root {
      --bg: #0b1021;
      --card: #121b33;
      --accent: #17c3b2;
      --accent-2: #f59e0b;
      --text: #e8f1ff;
      --muted: #9fb3ce;
      --grid: rgba(255, 255, 255, 0.05);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
      background: radial-gradient(140% 140% at 10% 20%, rgba(23,195,178,0.12), transparent 50%), radial-gradient(120% 120% at 80% 0%, rgba(245,158,11,0.1), transparent 55%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px clamp(20px, 4vw, 48px) 64px;
    }
    h1, h2, h3 { margin: 0; font-weight: 600; letter-spacing: -0.01em; }
    p { margin: 0; color: var(--muted); line-height: 1.6; }
    a { color: var(--accent); }
    .hero {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      align-items: center;
      margin-bottom: 28px;
    }
    .badge {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--grid);
      border-radius: 14px;
      font-size: 14px;
      color: var(--muted);
    }
    .badge span {
      display: inline-flex;
      width: 10px; height: 10px;
      background: var(--accent);
      border-radius: 50%;
      box-shadow: 0 0 0 6px rgba(23,195,178,0.15);
    }
    .hero h1 {
      font-size: clamp(28px, 4vw, 42px);
      line-height: 1.1;
    }
    .hero-note {
      display: grid;
      gap: 10px;
    }
    .hero-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    button {
      cursor: pointer;
      border: none;
      padding: 12px 16px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 15px;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      background: linear-gradient(120deg, var(--accent), #25e0cb);
      color: #041017;
      box-shadow: 0 10px 30px rgba(23,195,178,0.35);
    }
    button.secondary {
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      box-shadow: none;
      border: 1px solid var(--grid);
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      margin-top: 10px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--grid);
      border-radius: 18px;
      padding: 18px;
      position: relative;
      overflow: hidden;
    }
    .card:before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(140deg, rgba(23,195,178,0.08), rgba(245,158,11,0.05), transparent 50%);
      pointer-events: none;
    }
    .card h3 { font-size: 18px; margin-bottom: 6px; }
    .card small { color: var(--muted); }
    .list {
      display: grid;
      gap: 8px;
      margin-top: 10px;
      padding-left: 14px;
      color: var(--muted);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--grid);
      border-radius: 999px;
      font-size: 12px;
      color: var(--text);
    }
    .chart-wrap {
      height: 320px;
      margin-top: 12px;
    }
    select {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--grid);
      border-radius: 12px;
      color: var(--text);
      padding: 8px 10px;
      font-weight: 600;
    }
    .heatmap {
      width: 100%;
      height: 320px;
      margin-top: 12px;
    }
    .map {
      height: 340px;
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--grid);
    }
    .footer {
      margin-top: 28px;
      color: var(--muted);
      font-size: 14px;
    }
    code {
      font-family: "Red Hat Mono", "Space Grotesk", monospace;
      background: rgba(255,255,255,0.06);
      padding: 2px 6px;
      border-radius: 8px;
      color: var(--accent-2);
    }
  </style>
</head>
<body>
  <div class="hero">
    <div class="hero-note">
      <div class="badge"><span></span>Тема 5 · Заняття 4</div>
      <h1>Підбір візуальних елементів: від класифікації до практики</h1>
      <p>Сторінка створена для групового заняття з військовими аналітиками. Вона показує, як один набір даних можна подати різними візуальними мовами — графіки, теплокарти та мапа операцій.</p>
      <div class="hero-actions">
        <button id="regenerate">Згенерувати нові дані</button>
        <button class="secondary" id="toggleLegend">Показати конспект</button>
      </div>
    </div>
    <div class="card">
      <h3>Коротка класифікація</h3>
      <div class="list">
        <div class="pill">Порівняння · стовпчики / груповані лінії</div>
        <div class="pill">Частки · секторні / кільцеві</div>
        <div class="pill">Динаміка · лінії / area / spark</div>
        <div class="pill">Розподіл · boxplot / heatmap</div>
        <div class="pill">Простір · точкові / хлороплет / маркери</div>
      </div>
      <p style="margin-top:12px">Підбираємо елемент залежно від запитання: <strong>що змінюється</strong>, <strong>де</strong> та <strong>яку точність</strong> потрібно показати.</p>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <h3>Порівняння напрямків</h3>
          <small>Оберіть форму: стовпчики / лінія / radar</small>
        </div>
        <select id="compareType">
          <option value="bar">Стовпчики</option>
          <option value="line">Лінія</option>
          <option value="radar">Radar</option>
        </select>
      </div>
      <div class="chart-wrap"><canvas id="compareChart"></canvas></div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <h3>Частки ресурсів</h3>
          <small>Демонстрація секторної / кільцевої логіки</small>
        </div>
        <select id="shareType">
          <option value="doughnut">Кільце</option>
          <option value="pie">Сектори</option>
          <option value="polarArea">Polar</option>
        </select>
      </div>
      <div class="chart-wrap"><canvas id="shareChart"></canvas></div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <h3>Динаміка операцій</h3>
          <small>Лінія + область для зміни у часі</small>
        </div>
        <select id="trendType">
          <option value="line">Лінія</option>
          <option value="bar">Колонки</option>
          <option value="scatter">Scatter</option>
        </select>
      </div>
      <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <h3>Взаємозв'язок факторів</h3>
          <small>Кореляція інтенсивності vs. час</small>
        </div>
        <select id="correlationType">
          <option value="scatter">Scatter</option>
          <option value="bubble">Bubble</option>
        </select>
      </div>
      <div class="chart-wrap"><canvas id="correlationChart"></canvas></div>
    </div>

    <div class="card">
      <h3>Теплокарта важливості</h3>
      <small>Категорії × час показують інтенсивність</small>
      <div id="heatmap" class="heatmap"></div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <h3>Просторова ситуація</h3>
          <small>Маркери на мапі + колір за рівнем активності</small>
        </div>
        <div class="pill">Leaflet · OSM</div>
      </div>
      <div id="map" class="map"></div>
    </div>

    <div class="card" id="legendCard" style="display:none;">
      <h3>Поради з підбору</h3>
      <div class="list">
        <div><strong>1. Питання</strong>: що хочемо донести? тренд, порівняння, структуру чи географію.</div>
        <div><strong>2. Рівень точності</strong>: чим більше точності, тим менше «декору» і більше опорних осей.</div>
        <div><strong>3. Когнітивне навантаження</strong>: не перевантажуйте кольорами; 5–7 категорій — комфортна межа.</div>
        <div><strong>4. Кольорова логіка</strong>: теплі = напруга/ризик, холодні = стабільність; нейтральні для підписів.</div>
        <div><strong>5. Сумісність</strong>: синхронізуйте легенди/масштаби між графіками, щоб читач не губився.</div>
      </div>
      <p style="margin-top:12px">Комбінуйте різні елементи для однієї історії: порівняння + карта + динаміка створюють повну картину.</p>
    </div>
  </div>

  <div class="footer">
    Збережено у папці <code>Theme5/GroupLesson54/codex</code>. Відкрийте <code>index.html</code> у браузері або через live-server для повної інтерактивності.
  </div>

  <script>
    const palette = ["#17c3b2", "#f59e0b", "#8b5cf6", "#4ade80", "#38bdf8", "#ef4444"];
    let compareChart, shareChart, trendChart, correlationChart, map, heatmapData;

    const categories = ["Маневри", "Логістика", "Розвідка", "Кібер", "ППО", "Дрони"];
    const periods = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Нд"];

    function randomRange(min, max) {
      return Math.round(Math.random() * (max - min) + min);
    }

    function generateDataset() {
      const compare = categories.map(() => randomRange(25, 95));
      const shares = categories.map(() => randomRange(10, 50));
      const trend = periods.map(() => randomRange(30, 120));
      const correlation = Array.from({ length: 24 }, (_, i) => {
        const x = i + 1;
        const base = x * 1.8 + randomRange(8, 28);
        return { x, y: base + randomRange(-12, 12), r: randomRange(5, 12) };
      });

      heatmapData = categories.map(cat => periods.map(day => ({
        cat,
        day,
        value: randomRange(5, 100)
      })));

      const mapPoints = Array.from({ length: 7 }, (_, i) => ({
        name: categories[i % categories.length],
        level: randomRange(1, 3),
        coords: [
          49.5 + Math.random() * 2.5, // широта в межах України
          29.5 + Math.random() * 8.5  // довгота
        ]
      }));

      return { compare, shares, trend, correlation, mapPoints };
    }

    function initCharts(data) {
      const compareCtx = document.getElementById("compareChart");
      const shareCtx = document.getElementById("shareChart");
      const trendCtx = document.getElementById("trendChart");
      const correlationCtx = document.getElementById("correlationChart");

      const compareType = document.getElementById("compareType").value;
      const shareType = document.getElementById("shareType").value;
      const trendType = document.getElementById("trendType").value;
      const correlationType = document.getElementById("correlationType").value;

      const compareConfig = {
        type: compareType,
        data: {
          labels: categories,
          datasets: [{
            label: "Показник",
            data: data.compare,
            fill: compareType === "radar",
            backgroundColor: compareType === "line" ? "rgba(23,195,178,0.25)" : palette.map(c => c + "cc"),
            borderColor: compareType === "radar" ? "#17c3b2" : "#0ea5e9",
            tension: 0.3,
            borderWidth: 2,
          }]
        },
        options: {
          plugins: { legend: { display: compareType !== "bar" ? true : false } },
          scales: compareType === "radar" ? {} : { y: { grid: { color: "rgba(255,255,255,0.08)" }, ticks: { color: "#dce6ff" } }, x: { ticks: { color: "#dce6ff" } } }
        }
      };

      const shareConfig = {
        type: shareType,
        data: {
          labels: categories,
          datasets: [{
            data: data.shares,
            backgroundColor: palette.map(c => c + "dd"),
            borderColor: "#0b1021",
            borderWidth: 2,
          }]
        },
        options: { plugins: { legend: { position: "bottom", labels: { color: "#dce6ff" } } } }
      };

      const trendConfig = {
        type: trendType,
        data: {
          labels: periods,
          datasets: [{
            label: "Операції/день",
            data: data.trend,
            backgroundColor: trendType === "line" ? "rgba(56,189,248,0.25)" : "#17c3b2cc",
            borderColor: "#38bdf8",
            fill: trendType === "line",
            tension: 0.35,
            pointRadius: 4
          }]
        },
        options: {
          plugins: { legend: { display: true, labels: { color: "#dce6ff" } } },
          scales: { y: { grid: { color: "rgba(255,255,255,0.08)" }, ticks: { color: "#dce6ff" } }, x: { ticks: { color: "#dce6ff" } } }
        }
      };

      // Destroy previous to avoid memory leaks when switching types
      if (compareChart) compareChart.destroy();
      if (shareChart) shareChart.destroy();
      if (trendChart) trendChart.destroy();
      if (correlationChart) correlationChart.destroy();

      compareChart = new Chart(compareCtx, compareConfig);
      shareChart = new Chart(shareCtx, shareConfig);
      trendChart = new Chart(trendCtx, trendConfig);
      const corrDataset = correlationType === "bubble"
        ? data.correlation.map(d => ({ x: d.x, y: d.y, r: d.r }))
        : data.correlation.map(d => ({ x: d.x, y: d.y }));
      correlationChart = new Chart(correlationCtx, {
        type: correlationType === "bubble" ? "bubble" : "scatter",
        data: {
          datasets: [{
            label: "Інтенсивність",
            data: corrDataset,
            backgroundColor: "rgba(245,158,11,0.6)",
            borderColor: "#f59e0b",
            pointRadius: correlationType === "bubble" ? undefined : 6,
          }]
        },
        options: {
          plugins: { legend: { labels: { color: "#dce6ff" } } },
          scales: {
            x: { title: { display: true, text: "Час" }, grid: { color: "rgba(255,255,255,0.08)" }, ticks: { color: "#dce6ff" } },
            y: { title: { display: true, text: "Показник" }, grid: { color: "rgba(255,255,255,0.08)" }, ticks: { color: "#dce6ff" } },
          }
        }
      });
    }

    function renderHeatmap() {
      const container = d3.select("#heatmap");
      container.selectAll("*").remove();
      const width = container.node().clientWidth;
      const height = container.node().clientHeight;
      const margin = { top: 20, right: 10, bottom: 30, left: 80 };
      const innerW = width - margin.left - margin.right;
      const innerH = height - margin.top - margin.bottom;

      const svg = container.append("svg")
        .attr("width", width)
        .attr("height", height);

      const x = d3.scaleBand().domain(periods).range([0, innerW]).padding(0.08);
      const y = d3.scaleBand().domain(categories).range([0, innerH]).padding(0.08);
      const color = d3.scaleLinear().domain([0, 50, 100]).range(["#0b1021", "#17c3b2", "#f59e0b"]);

      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

      g.selectAll("rect")
        .data(heatmapData.flat())
        .enter()
        .append("rect")
        .attr("x", d => x(d.day))
        .attr("y", d => y(d.cat))
        .attr("width", x.bandwidth())
        .attr("height", y.bandwidth())
        .attr("rx", 6)
        .style("fill", d => color(d.value))
        .append("title")
        .text(d => `${d.cat} / ${d.day}: ${d.value}`);

      const axisColor = "#9fb3ce";
      g.append("g")
        .attr("transform", `translate(0,${innerH})`)
        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("fill", axisColor)
        .style("font-size", "12px");

      g.append("g")
        .call(d3.axisLeft(y))
        .selectAll("text")
        .attr("fill", axisColor)
        .style("font-size", "12px");
    }

    function initMap(points) {
      if (!map) {
        map = L.map("map", { zoomControl: false }).setView([49.5, 32], 6);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap",
        }).addTo(map);
      } else {
        map.eachLayer(layer => {
          if (layer instanceof L.Marker) map.removeLayer(layer);
        });
      }

      points.forEach(p => {
        const colors = ["#4ade80", "#f59e0b", "#ef4444"];
        const marker = L.circleMarker(p.coords, {
          radius: 10 + p.level * 2,
          color: colors[p.level - 1],
          weight: 2,
          fillColor: colors[p.level - 1],
          fillOpacity: 0.7
        });
        marker.bindPopup(`<strong>${p.name}</strong><br>Рівень: ${p.level}`);
        marker.addTo(map);
      });
    }

    function refreshAll() {
      const data = generateDataset();
      initCharts(data);
      renderHeatmap();
      initMap(data.mapPoints);
    }

    document.getElementById("regenerate").addEventListener("click", refreshAll);
    document.getElementById("compareType").addEventListener("change", refreshAll);
    document.getElementById("shareType").addEventListener("change", refreshAll);
    document.getElementById("trendType").addEventListener("change", refreshAll);
    document.getElementById("correlationType").addEventListener("change", refreshAll);
    document.getElementById("toggleLegend").addEventListener("click", () => {
      const card = document.getElementById("legendCard");
      const hidden = card.style.display === "none";
      card.style.display = hidden ? "block" : "none";
    });

    refreshAll();
  </script>
</body>
</html>
